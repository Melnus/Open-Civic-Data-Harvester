<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reality Harvester Portal 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <style>
        /* ã‚¹ãƒãƒ›ã®é«˜ã•å•é¡Œã‚’è§£æ±º */
        body { height: 100vh; height: 100dvh; }
        .chat-container { height: calc(100% - 160px); }
        pre { white-space: pre-wrap; word-break: break-all; }
        .user-bubble { background-color: #374151; border-radius: 1rem 1rem 0 1rem; }
        .ai-bubble { background-color: #1e3a8a; border-radius: 1rem 1rem 1rem 0; border: 1px solid #1e40af; }
        input, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col font-sans overflow-hidden">

    <!-- Header -->
    <header class="flex-none p-4 bg-gray-800 border-b border-purple-900/50 shadow-md z-10">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span class="text-2xl">ğŸšœ</span> Harvester <span class="text-[10px] bg-purple-600 px-2 py-0.5 rounded text-white font-black uppercase">v3.0 Flash</span>
            </h1>
            <button onclick="location.reload()" class="text-xs bg-gray-700 px-3 py-1 rounded-full text-gray-400">Reset</button>
        </div>
        <input type="password" id="api-key" class="w-full p-2 bg-gray-900/50 rounded-lg border border-gray-700 text-sm focus:ring-1 focus:ring-purple-500 outline-none" placeholder="Gemini API Keyã‚’å…¥åŠ›">
    </header>

    <!-- Main Chat Area -->
    <main id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 chat-container">
        <!-- åˆæœŸè¡¨ç¤ºï¼šçœŸã‚“ä¸­ã®å¤§ããªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
        <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-6">
            <label class="cursor-pointer group flex flex-col items-center">
                <div class="w-24 h-24 bg-purple-900/30 rounded-full flex items-center justify-center border-2 border-dashed border-purple-500 group-active:scale-95 transition-all">
                    <span class="text-5xl">ï¼‹</span>
                </div>
                <input type="file" id="file-input-center" class="hidden" accept=".pdf,.xls,.xlsx,image/*">
                <div class="mt-4">
                    <h2 class="text-lg font-bold text-purple-300">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                    <p class="text-xs text-gray-400 mt-1">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦PDFã‚„Excelã‚’é¸æŠ</p>
                </div>
            </label>
            <div class="text-[10px] text-gray-500 bg-gray-800 px-4 py-2 rounded-full border border-gray-700">
                Settlement / Migration / Population å¯¾å¿œ
            </div>
        </div>
    </main>

    <div id="status" class="px-4 py-1 text-[10px] text-purple-400 h-4 uppercase tracking-widest font-bold font-mono"></div>

    <!-- Footer -->
    <footer class="flex-none p-4 bg-gray-800 border-t border-gray-700 shadow-[0_-4px_10px_rgba(0,0,0,0.3)]">
        <div class="flex gap-2 items-center">
            <label class="flex-none w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center cursor-pointer active:scale-90 transition">
                <span class="text-2xl text-white">ğŸ“</span>
                <input type="file" id="file-input-footer" class="hidden" accept=".pdf,.xls,.xlsx,image/*">
            </label>
            <input type="text" id="user-input" class="flex-1 bg-gray-900/50 rounded-xl px-4 h-12 focus:outline-none border border-gray-700 text-sm" placeholder="AIã¸ã®æŒ‡ç¤º...">
            <button id="send-btn" class="flex-none w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center font-bold active:scale-90 transition text-white text-xs">Go</button>
        </div>
    </footer>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const PROJECT_SCHEMAS = `
        ä»¥ä¸‹ã®Typescriptå‹å®šç¾©ã‚’å³å®ˆã—ã¦JSONã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
        interface SettlementData { fiscal_year, prefecture, source, population, total_revenue, total_expenditure, real_balance, local_tax, local_consumption_tax }
        interface MigrationData { fiscal_year, prefecture, area, source, domestic_in, domestic_out, international_in, international_out, social_increase }
        interface PopulationData { fiscal_year, prefecture, area, source, total_population, births, deaths }
        `;

        const SYSTEM_INSTRUCTION = `
        ã‚ãªãŸã¯è¡Œæ”¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã®å°‚é–€å®¶ã§ã™ã€‚ãƒ¢ãƒ‡ãƒ«: Gemini 3.0 Flashã€‚
        1. æ‚ªç”¨ãƒã‚§ãƒƒã‚¯: æ¼«ç”»ã€ã‚¤ãƒ©ã‚¹ãƒˆã€ç„¡é–¢ä¿‚ãªå†™çœŸã¯ã€Œãã‚Œã¯ã€‡ã€‡ãªã®ã§ä½¿ãˆã¾ã›ã‚“ã€ã¨æ‹’å¦ã€‚
        2. åˆ¤å®šã¨æŠ½å‡º: è³‡æ–™ã‚’åˆ¤å®šã—ã€ä»¥ä¸‹ã®ã‚¹ã‚­ãƒ¼ãƒã«åŸºã¥ãJSONã‚’ç”Ÿæˆã€‚ ${PROJECT_SCHEMAS}
        3. å‡ºåŠ›: JSONã‚’ \`\`\`json ... \`\`\` ã§å›²ã‚“ã§å‡ºåŠ›ã€‚
        `;

        let chatSession = null;
        const chatBox = document.getElementById('chat-box');
        const status = document.getElementById('status');

        function appendMessage(role, text, isJson = false) {
            const welcome = document.getElementById('welcome-screen');
            if(welcome) welcome.remove();

            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            const div = document.createElement('div');
            div.className = `max-w-[90%] p-3 text-sm shadow-sm ${role === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            
            if (isJson) {
                div.innerHTML = `<div class="text-[10px] font-mono text-purple-300 mb-1">HARVESTED_JSON:</div><pre class="text-green-400 bg-black p-2 rounded text-[10px] select-all font-mono overflow-x-auto border border-purple-500/30">${text}</pre>`;
                const btn = document.createElement('button');
                btn.innerText = "ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼";
                btn.className = "mt-2 w-full py-2 bg-purple-700/50 rounded-lg text-xs font-bold transition active:bg-purple-500";
                btn.onclick = () => {
                    navigator.clipboard.writeText(text);
                    btn.innerText = "âœ… COPIED";
                    setTimeout(() => btn.innerText = "ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼", 2000);
                };
                div.appendChild(btn);
            } else {
                div.innerText = text;
            }
            wrapper.appendChild(div);
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function initChat() {
            const apiKey = document.getElementById('api-key').value;
            if (!apiKey) throw new Error("API KEYã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-3.0-flash" });
            return model.startChat({
                history: [
                    { role: "user", parts: [{ text: SYSTEM_INSTRUCTION }] },
                    { role: "model", parts: [{ text: "READY (3.0 Flash). è¡Œæ”¿è³‡æ–™ã‚’è§£æã—ã¾ã™ã€‚" }] }
                ]
            });
        }

        async function handleSend(file = null) {
            const userInput = document.getElementById('user-input');
            const text = userInput.value;
            if (!text && !file) return;

            try {
                if (!chatSession) chatSession = await initChat();
                status.innerText = "AI Harvesting (3.0)...";
                
                let messageParts = [];
                if (text) {
                    appendMessage('user', text);
                    messageParts.push({ text });
                    userInput.value = '';
                }

                if (file) {
                    appendMessage('user', `ğŸ“„ ${file.name}`);
                    const base64Data = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    messageParts.push({ inlineData: { data: base64Data, mimeType: file.type } });
                }

                const result = await chatSession.sendMessage(messageParts);
                const responseText = result.response.text();

                const jsonMatch = responseText.match(/```json\s?([\s\S]*?)```/) || responseText.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
                
                if (jsonMatch) {
                    const cleanJson = jsonMatch[1] || jsonMatch[0];
                    const beforeText = responseText.split('```')[0];
                    if (beforeText.trim() && beforeText.length < 200) appendMessage('model', beforeText);
                    appendMessage('model', cleanJson.trim(), true);
                } else {
                    appendMessage('model', responseText);
                }
            } catch (err) {
                appendMessage('model', "ERROR: " + err.message);
                chatSession = null;
            } finally {
                status.innerText = "";
            }
        }

        document.getElementById('send-btn').onclick = () => handleSend();
        document.getElementById('file-input-center').onchange = (e) => handleSend(e.target.files[0]);
        document.getElementById('file-input-footer').onchange = (e) => handleSend(e.target.files[0]);
        document.getElementById('user-input').onkeypress = (e) => { if(e.key === 'Enter') handleSend(); };
    </script>
</body>
</html>
