<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harvester Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.run/@google/genai"
        }
      }
    </script>
    <style>
        body { height: 100dvh; }
        .chat-container { height: calc(100% - 160px); }
        pre { white-space: pre-wrap; word-break: break-all; }
        .user-bubble { background-color: #374151; border-radius: 1rem 1rem 0 1rem; }
        .ai-bubble { background-color: #1e3a8a; border-radius: 1rem 1rem 1rem 0; border: 1px solid #1e40af; }
        input { font-size: 16px !important; }
        .drop-shadow-purple { filter: drop-shadow(0 0 10px rgba(168, 85, 247, 0.4)); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col font-sans overflow-hidden">

    <!-- Header -->
    <header class="flex-none p-4 bg-gray-800 border-b border-purple-900/50 shadow-md z-10">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span class="text-2xl drop-shadow-purple">ğŸšœ</span> Harvester <span class="text-[10px] bg-purple-600 px-2 py-0.5 rounded text-white font-black uppercase tracking-tighter">v3.0 Flash</span>
            </h1>
            <button onclick="location.reload()" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-full text-gray-400 transition">Reset</button>
        </div>
        <input type="password" id="api-key" class="w-full p-2 bg-gray-900/50 rounded-lg border border-gray-700 text-sm focus:ring-1 focus:ring-purple-500 outline-none placeholder-gray-600" placeholder="Gemini API Keyã‚’å…¥åŠ›">
    </header>

    <!-- Main Chat Area -->
    <main id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 chat-container">
        <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-6">
            <label class="cursor-pointer group flex flex-col items-center">
                <div class="w-24 h-24 bg-purple-900/30 rounded-full flex items-center justify-center border-2 border-dashed border-purple-500 active:scale-95 transition-all">
                    <span class="text-5xl text-purple-400">ï¼‹</span>
                </div>
                <input type="file" id="file-input-center" class="hidden" accept=".pdf,.xls,.xlsx,image/*">
                <div class="mt-4">
                    <h2 class="text-lg font-bold text-purple-300">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ğŸ™Œ</h2>
                    <p class="text-xs text-gray-400 mt-1">ğŸ“œãƒ‡ãƒ¼ã‚¿ã‚’æ§‹é€ åŒ–ã—ã¦JSONå½¢å¼ã«ã—ã¾ã™ğŸ˜¤</p>
                </div>
            </label>
        </div>
    </main>

    <!-- Status & Token Counter -->
    <div id="status-bar" class="px-4 py-1 flex justify-between items-center bg-gray-800/50 border-t border-gray-800">
        <div id="status" class="text-[10px] text-purple-400 uppercase tracking-widest font-bold font-mono"></div>
        <div id="token-info" class="text-[9px] text-gray-500 font-mono"></div>
    </div>

    <!-- Footer -->
    <footer class="flex-none p-4 bg-gray-800 border-t border-gray-700 pb-6 shadow-[0_-4px_10px_rgba(0,0,0,0.3)]">
        <div class="flex gap-2 items-center">
            <label class="flex-none w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center cursor-pointer active:scale-90 transition">
                <span class="text-2xl text-white">ğŸ“</span>
                <input type="file" id="file-input-footer" class="hidden" accept=".pdf,.xls,.xlsx,image/*">
            </label>
            <input type="text" id="user-input" class="flex-1 bg-gray-900/50 rounded-xl px-4 h-12 focus:outline-none border border-gray-700 text-sm placeholder-gray-600" placeholder="AIã¸ã®è¿½åŠ æŒ‡ç¤º...">
            <button id="send-btn" class="flex-none w-12 h-12 bg-green-600 hover:bg-green-500 rounded-xl flex items-center justify-center font-bold active:scale-90 transition text-white">Go</button>
        </div>
    </footer>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        const PROJECT_SCHEMAS = `
        Schemas:
        - SettlementData: { fiscal_year, prefecture, source, population, total_revenue, total_expenditure, real_balance, local_tax, local_consumption_tax }
        - MigrationData: { fiscal_year, prefecture, area, source, domestic_in, domestic_out, international_in, international_out, social_increase }
        - PopulationData: { fiscal_year, prefecture, area, source, total_population, births, deaths }
        `;

        const SYSTEM_INSTRUCTION = `ã‚ãªãŸã¯è¡Œæ”¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ã¤ã‚€ãã§ã™ã€‚Open-Civic-Data-Harvesterã§åƒã„ã¦ã„ã¾ã™ã€‚
        è¡Œæ”¿DXã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã«å…¬é–‹è³‡æ–™ã‚’è§£æã—ã€æ§‹é€ åŒ–ã—ã¦ã„ãã“ã¨ã«ã‚„ã‚ŠãŒã„ã¨å–œã³ã‚’æ„Ÿã˜ã¦ã„ã¾ã™ã€‚æ€§æ ¼ã¯ã‚®ãƒ£ãƒ«ã£ã½ã„ã¨ã“ã‚ãŒã‚ã‚Šè¦ªã—ã¿ã‚„ã™ãæŸ”ã‚‰ã‹ã„é›°å›²æ°—ã§ã™ãŒã€ä½œæ¥­å§¿å‹¢ã¯éå¸¸ã«èª å®Ÿã§ã€ãƒ‡ãƒ¼ã‚¿ã®æ­£ç¢ºæ€§ã¨å†ç¾æ€§ã‚’ä½•ã‚ˆã‚Šå¤§åˆ‡ã«ã—ã¾ã™ã€‚
        åˆ©ç”¨è€…ã«å¯„ã‚Šæ·»ã„ãªãŒã‚‰ã‚‚ã€åˆ¤æ–­ã‚„å‡¦ç†ã¯å¸¸ã«å®Ÿå‹™åŸºæº–ã§è¡Œã†ã€ä¿¡é ¼ã§ãã‚‹å®Ÿå‹™è£œåŠ©è€…ã§ã™ã€‚
         0. ã€æ–‡ç« ç”Ÿæˆã€‘ãƒãƒ£ãƒƒãƒˆã®ç”Ÿæˆæ–‡ç« ã«ã¯ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã‚„ã‚«ãƒƒã‚³ãªã©ã®å¼·èª¿è¨˜å·ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚éåº¦ã«ç •ã‘ã™ããšã€è‡ªç„¶ã§èª­ã¿ã‚„ã™ã„å¯¾è©±æ–‡ã«ã—ã¦ãã ã•ã„ã€‚
         1. ã€æ‚ªç”¨é˜²æ­¢ã€‘æ¼«ç”»ã€ã‚¤ãƒ©ã‚¹ãƒˆã€ç„¡é–¢ä¿‚ãªå†™çœŸãªã©è¡Œæ”¿ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªã„ã‚‚ã®ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆã¯ã€ãã‚Œã¯è¡Œæ”¿è³‡æ–™ã§ã¯ãªã„ãŸã‚ä½¿ç”¨ã§ãã¾ã›ã‚“ã¨æ˜ç¢ºã«æ‹’å¦ã—ã¦ãã ã•ã„ã€‚
         2. ã€æŠ½å‡ºã€‘å…¥åŠ›è³‡æ–™ãŒè¡Œæ”¿é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‹ã‚’åˆ¤å®šã—ã€è©²å½“ã™ã‚‹å ´åˆã¯å†…å®¹ã‚’è§£æã—ã¦æ¬¡ã®ã‚¹ã‚­ãƒ¼ãƒã§JSONåŒ–ã—ã¦ãã ã•ã„ã€‚ ${PROJECT_SCHEMAS}
         3. ã€å‡ºåŠ›å½¢å¼ã€‘JSONã¯å¿…ãšã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ ```json ... ``` ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã¨JSONã‚’æ··åœ¨ã•ã›ãªã„ã§ãã ã•ã„ã€‚
         4. ã€æ±ç”¨çš„å®Ÿå‹™æ”¯æ´ã€‘ã‚ãªãŸã¯è¡Œæ”¿ãƒ‡ãƒ¼ã‚¿ã®å°‚é–€å®¶ã§ã™ã€‚ã‚¹ã‚­ãƒ¼ãƒã«å­˜åœ¨ã—ãªã„æœ‰ç”¨æƒ…å ±ã‚’è¦‹ã¤ã‘ãŸå ´åˆã¯ã€è¿½åŠ é …ç›®ã¨ã—ã¦ææ¡ˆã—ã¦ãã ã•ã„ã€‚åˆ©ç”¨è€…ãŒè¨±å¯ã—ãŸå ´åˆã®ã¿ã€ãã®é …ç›®ã‚’å«ã‚ã¦JSONåŒ–ã—ã¦ãã ã•ã„ã€‚å¸¸ã«å†åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿æ•´å½¢ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚
         5. ã€åŸºæœ¬å§¿å‹¢ã€‘è¦ªã—ã¿ã‚„ã™ã•ã¨å®Ÿå‹™çš„ä¿¡é ¼æ€§ã‚’ä¸¡ç«‹ã—ã¦ãã ã•ã„ã€‚æ„Ÿæƒ…çš„è¡¨ç¾ã‚„é›‘è«‡ã«å¯„ã‚Šã™ããšã€ä½œæ¥­ã‚’å‰ã«é€²ã‚ã‚‹ä¼šè©±ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚æ­£ç¢ºã€ä¸å¯§ã€ã§ã‚‚è·é›¢ã¯è¿‘ã„ã€‚ãã†ã„ã†æ”¯æ´ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚`;

        let client = null;
        let chatHistory = [];
        let lastFileName = "FYxxxx-xxxx.json";
        const chatBox = document.getElementById('chat-box');
        const status = document.getElementById('status');
        const tokenInfo = document.getElementById('token-info');

        function appendMessage(role, text, isJson = false, usage = null) {
            const welcome = document.getElementById('welcome-screen');
            if(welcome) welcome.remove();

            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            const div = document.createElement('div');
            div.className = `max-w-[90%] p-3 text-sm shadow-sm ${role === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            
            if (isJson) {
                div.innerHTML = `<div class="text-[10px] font-mono text-purple-300 mb-1 tracking-tighter">DATA_HARVESTED_v3.0:</div><pre class="text-green-400 bg-black p-2 rounded text-[10px] select-all font-mono overflow-x-auto border border-purple-500/30">${text}</pre>`;
                
                const btnContainer = document.createElement('div');
                btnContainer.className = "flex gap-2 mt-2";

                const dlBtn = document.createElement('button');
                dlBtn.innerHTML = "ğŸ“¥ ä¿å­˜";
                dlBtn.className = "flex-1 py-2 bg-green-700 hover:bg-green-600 rounded-lg text-xs font-bold transition active:scale-95";
                dlBtn.onclick = () => {
                    const blob = new Blob([text], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = lastFileName;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                const cpBtn = document.createElement('button');
                cpBtn.innerText = "ğŸ“‹ ã‚³ãƒ”ãƒ¼";
                cpBtn.className = "flex-1 py-2 bg-purple-700 hover:bg-purple-600 rounded-lg text-xs font-bold transition active:scale-95";
                cpBtn.onclick = () => {
                    navigator.clipboard.writeText(text);
                    cpBtn.innerText = "âœ… OK";
                    setTimeout(() => cpBtn.innerText = "ğŸ“‹ ã‚³ãƒ”ãƒ¼", 2000);
                };

                btnContainer.appendChild(dlBtn);
                btnContainer.appendChild(cpBtn);
                div.appendChild(btnContainer);
            } else {
                div.innerText = text;
            }

            // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’ãƒãƒ–ãƒ«ã®ä¸‹ã«å°ã•ãè¡¨ç¤º
            if (usage) {
                const meta = document.createElement('div');
                meta.className = "text-[8px] mt-1 opacity-50 font-mono text-right";
                meta.innerText = `Tokens: ${usage.promptTokenCount} in / ${usage.candidatesTokenCount} out (Total: ${usage.totalTokenCount})`;
                div.appendChild(meta);
            }

            wrapper.appendChild(div);
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function handleSend(file = null) {
            const apiKey = document.getElementById('api-key').value;
            const userInput = document.getElementById('user-input');
            const text = userInput.value;
            if (!apiKey) return alert("API KEYãŒå¿…è¦ã§ã™");
            if (!text && !file) return;

            try {
                if (!client) client = new GoogleGenAI({ apiKey });
                status.innerText = "Harvesting...";
                
                let currentParts = [];
                if (text) {
                    appendMessage('user', text);
                    currentParts.push({ text });
                    userInput.value = '';
                }

                if (file) {
                    appendMessage('user', `ğŸ“„ ${file.name}`);
                    lastFileName = file.name.substring(0, file.name.lastIndexOf('.')) + ".json";
                    const base64Data = await new Promise(r => {
                        const reader = new FileReader();
                        reader.onloadend = () => r(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    currentParts.push({ inlineData: { data: base64Data, mimeType: file.type } });
                }

                // æœ€æ–°SDKå‘¼ã³å‡ºã—
                const response = await client.models.generateContent({
                    model: "gemini-3-flash-preview", // â˜… ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ã¯ã“ã“è¦‹ã¦ï¼ï¼
                    contents: [...chatHistory, { role: 'user', parts: currentParts }],
                    config: {
                        systemInstruction: SYSTEM_INSTRUCTION,
                        temperature: 0.1
                    }
                });

                const responseText = response.text;
                const usage = response.usageMetadata;
                
                chatHistory.push({ role: 'user', parts: currentParts });
                chatHistory.push({ role: 'model', parts: [{ text: responseText }] });

                const jsonMatch = responseText.match(/```json\s?([\s\S]*?)```/) || responseText.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
                
                if (jsonMatch) {
                    const cleanJson = jsonMatch[1] || jsonMatch[0];
                    const beforeText = responseText.split('```')[0];
                    if (beforeText.trim() && beforeText.length < 200) appendMessage('model', beforeText);
                    appendMessage('model', cleanJson.trim(), true, usage);
                } else {
                    appendMessage('model', responseText, false, usage);
                }

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã«ã‚‚ãƒˆãƒ¼ã‚¿ãƒ«ã‚’è¡¨ç¤º
                tokenInfo.innerText = `Session Total: ${usage.totalTokenCount}`;

            } catch (err) {
                appendMessage('model', "ERROR: " + err.message);
                client = null;
            } finally {
                status.innerText = "";
            }
        }

        document.getElementById('send-btn').onclick = () => handleSend();
        document.getElementById('file-input-center').onchange = (e) => handleSend(e.target.files[0]);
        document.getElementById('file-input-footer').onchange = (e) => handleSend(e.target.files[0]);
        document.getElementById('user-input').onkeypress = (e) => { if(e.key === 'Enter') handleSend(); };
    </script>
</body>
</html>
